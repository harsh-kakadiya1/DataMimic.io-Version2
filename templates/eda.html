{% extends "base.html" %}

{% block title %}EDA & Pre-processing{% endblock %}

{% block head_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <a href="{{ url_for('home') }}" class="back-button">
        <i class="fas fa-arrow-left"></i> Back to Home
    </a>
    <div class="eda-content">
        <div class="eda-hero-section">
            <h1 class="eda-hero-title">No-Code EDA & Pre-processing</h1>
            <p class="eda-hero-subtitle">Upload your data and perform analysis and cleaning without writing a single line of code.</p>
        </div>

        <!-- Step 1: File Upload -->
        <div class="form-group">
            <h3><i class="fas fa-upload"></i> Step 1: Upload Your Data</h3>
            <form id="uploadForm" action="{{ url_for('upload_eda_file') }}" method="POST" enctype="multipart/form-data">
                <div class="file-upload-container">
                    <div class="file-drop-zone" id="fileDropZone">
                        <div class="file-drop-content">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <h4>Drop your file here</h4>
                            <p class="upload-text">Excel and CSV supported</p>
                            <p class="upload-info">Max file size: 100MB â€¢ Allowed: .csv, .xlsx</p>
                            <button type="button" class="browse-btn" id="browseBtn">
                                <i class="fas fa-folder-open"></i> Browse Files
                            </button>
                        </div>
                        <div class="file-preview" id="filePreview" style="display: none;">
                            <div class="file-info">
                                <i class="fas fa-file-excel file-icon"></i>
                                <div class="file-details">
                                    <span class="file-name" id="fileName"></span>
                                    <span class="file-size" id="fileSize"></span>
                                </div>
                                <button type="button" class="remove-file-btn" id="removeFileBtn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <input type="file" id="fileUpload" name="file" accept=".csv,.xlsx" required style="display: none;">
                </div>
                <button type="submit" class="generate-btn" id="uploadSubmitBtn" style="display: none;">
                    <i class="fas fa-upload"></i> Upload File
                </button>
            </form>
        </div>

        <div id="eda-loading" class="loading">
            <div class="spinner"></div>
            <p>Processing data...</p>
        </div>

        <div id="eda-results" class="results" style="display: none;">
            <!-- Step 2: Data Overview -->
            <div class="form-group">
                <h3><i class="fas fa-chart-bar"></i> Step 2: Data Overview</h3>
                <div class="data-stats">
                    <div class="stats-grid">
                        <div class="stat-item"><span class="stat-label">Total Rows:</span> <span class="stat-value" id="eda-total-rows">0</span></div>
                        <div class="stat-item"><span class="stat-label">Total Columns:</span> <span class="stat-value" id="eda-total-cols">0</span></div>
                        <div class="stat-item"><span class="stat-label">File Size:</span> <span class="stat-value" id="eda-file-size">0 KB</span></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Data Preview -->
            <div class="form-group">
                <h3><i class="fas fa-eye"></i> Step 3: Data Preview</h3>
                <div class="table-container">
                    <div class="preview-controls mb-3">
                        <label for="previewRows" class="form-label">Number of rows to preview:</label>
                        <select id="previewRows" class="form-control" style="width: auto; display: inline-block; margin-left: 10px;">
                            <option value="10">10 rows</option>
                            <option value="25">25 rows</option>
                            <option value="50">50 rows</option>
                            <option value="100">100 rows</option>
                        </select>
                        <button id="refreshPreview" class="generate-btn small-btn" style="margin-left: 10px;">
                            <i class="fas fa-sync-alt"></i> Refresh Preview
                        </button>
                    </div>
                    <div id="dataPreviewContainer">
                        <table id="dataPreviewTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <!-- Column headers will be dynamically inserted here -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Step 4: Column Analysis -->
            <div class="form-group">
                <h3><i class="fas fa-columns"></i> Step 4: Column Analysis</h3>
                <div class="table-container">
                    <table id="columnDetailsTable" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Column Name</th>
                                <th>Data Type</th>
                                <th>Non-Null Count</th>
                                <th>Missing (%)</th>
                                <th>Unique Values</th>
                                <th>Min</th>
                                <th>Max</th>
                                <th>Mean</th>
                                <th>Median</th>
                                <th>Mode</th>
                                <th>Std Dev</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Column details will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Step 5: Data Visualization -->
            <div class="form-group">
                <h3><i class="fas fa-chart-line"></i> Step 5: Data Visualization</h3>
                <div class="chart-controls">
                    <div style="display: flex; gap: 1em; align-items: center; flex-wrap: wrap; margin-bottom: 1rem;">
                        <label for="chartType">Chart Type:</label>
                        <select id="chartType" class="form-control" style="width: auto;">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="pie">Pie Chart</option>
                            <option value="scatter">Scatter Plot</option>
                            <option value="histogram">Histogram</option>
                        </select>
                        <label for="xColumn">X Column:</label>
                        <select id="xColumn" class="form-control" style="width: auto;"></select>
                        <label for="yColumn">Y Column:</label>
                        <select id="yColumn" class="form-control" style="width: auto;"></select>
                        <button id="drawChartBtn" class="generate-btn small-btn" style="display: none;">
                            <i class="fas fa-chart-bar"></i> Draw Chart
                        </button>
                        <button id="smartChartBtn" class="generate-btn small-btn" style="background: linear-gradient(135deg, #ff9800, #ffb74d);">
                            <i class="fas fa-magic"></i> Smart Chart
                        </button>
                    </div>
                    <div style="margin-top: 1em; position: relative; width: 100%;">
                        <div style="position: relative; width: 100%; height: 400px;">
                            <canvas id="edaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 6: Data Pre-processing Operations -->
            <div class="form-group">
                <h3><i class="fas fa-tools"></i> Step 6: Data Pre-processing</h3>
                
                <!-- 6.1 Missing Value Handling -->
                <div class="preprocessing-section">
                    <h4><i class="fas fa-exclamation-triangle"></i> Missing Value Handling</h4>
                    <div class="button-group">
                        <button class="generate-btn small-btn" data-action="remove_rows_missing">Remove Rows with Any Missing Values</button>
                        <input type="number" id="missing_col_threshold" placeholder="e.g., 50" min="0" max="100" class="input-inline">
                        <button class="generate-btn small-btn" data-action="remove_cols_high_missing">Remove Columns with > % Missing</button>
                    </div>

                    <h5 class="mt-3">Impute Missing Values:</h5>
                    <div class="mb-3">
                        <label for="impute_numerical_cols" class="form-label">Numerical Columns:</label>
                        <select multiple class="form-control" id="impute_numerical_cols" style="min-height: 100px;"></select>
                        <div class="button-group mt-2">
                            <button class="generate-btn small-btn" data-action="impute_mean">Impute with Mean</button>
                            <button class="generate-btn small-btn" data-action="impute_median">Impute with Median</button>
                            <button class="generate-btn small-btn" data-action="impute_mode_num">Impute with Mode</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="impute_categorical_cols" class="form-label">Categorical Columns:</label>
                        <select multiple class="form-control" id="impute_categorical_cols" style="min-height: 100px;"></select>
                        <div class="button-group mt-2">
                            <button class="generate-btn small-btn" data-action="impute_mode_cat">Impute with Mode (Categorical)</button>
                        </div>
                    </div>
                </div>

                <!-- 6.2 Duplicate Handling -->
                <div class="preprocessing-section">
                    <h4><i class="fas fa-copy"></i> Duplicate Handling</h4>
                    <button class="generate-btn small-btn" data-action="remove_duplicate_rows">Remove Duplicate Rows</button>
                </div>

                <!-- 6.3 Column Management -->
                <div class="preprocessing-section">
                    <h4><i class="fas fa-columns"></i> Column Management</h4>
                    <label for="remove_columns_select" class="form-label">Select Columns to Remove:</label>
                    <select multiple class="form-control" id="remove_columns_select" style="min-height: 100px;"></select>
                    <button class="generate-btn small-btn mt-2" data-action="remove_selected_columns">Remove Selected Columns</button>
                </div>

                <!-- 6.4 Data Type Conversion -->
                <div class="preprocessing-section">
                    <h4><i class="fas fa-exchange-alt"></i> Data Type Conversion</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="convert_col_select" class="form-label">Select Column:</label>
                            <select class="form-control" id="convert_col_select"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="convert_to_type" class="form-label">Convert To:</label>
                            <select class="form-control" id="convert_to_type">
                                <option value="">-- Select Type --</option>
                                <option value="int">Integer</option>
                                <option value="float">Float</option>
                                <option value="str">String</option>
                                <option value="bool">Boolean</option>
                                <option value="datetime">Date/Time</option>
                            </select>
                        </div>
                    </div>
                    <button class="generate-btn small-btn" data-action="change_data_type">Apply Type Conversion</button>
                </div>

                <!-- 6.5 Data Scaling & Normalization -->
                <div class="preprocessing-section">
                    <h4><i class="fas fa-balance-scale"></i> Data Scaling & Normalization</h4>
                    <label for="scaling_cols_select" class="form-label">Select Numerical Columns to Scale:</label>
                    <select multiple class="form-control" id="scaling_cols_select" style="min-height: 100px;"></select>
                    <div class="button-group mt-2">
                        <button class="generate-btn small-btn" data-action="min_max_scale">Min-Max Scaling (0-1)</button>
                        <button class="generate-btn small-btn" data-action="standardize">Standardization (Z-score)</button>
                    </div>
                </div>

                <!-- 6.6 Text Cleaning -->
                <div class="preprocessing-section">
                    <h4><i class="fas fa-font"></i> Text Cleaning: Capitalization</h4>
                    <label for="text_clean_cols" class="form-label">Select Text Columns to Clean:</label>
                    <select multiple class="form-control" id="text_clean_cols" style="min-height: 100px;"></select>
                    <div class="button-group mt-2">
                        <button class="generate-btn small-btn" data-action="uppercase">To UPPERCASE</button>
                        <button class="generate-btn small-btn" data-action="lowercase">To lowercase</button>
                        <button class="generate-btn small-btn" data-action="titlecase">To Title Case</button>
                    </div>
                </div>
            </div>

            <!-- Step 7: Download Processed Data -->
            <div class="form-group" style="margin-bottom: 5rem;">
                <h3><i class="fas fa-download"></i> Step 7: Download Processed Data</h3>
                <div class="text-center">
                    <div class="button-group justify-content-center">
                        <button class="download-btn" data-download-format="csv">
                            <i class="fas fa-file-csv"></i> Download CSV
                        </button>
                        <button class="download-btn" data-download-format="json">
                            <i class="fas fa-file-code"></i> Download JSON
                        </button>
                        <button class="download-btn" data-download-format="xlsx">
                            <i class="fas fa-file-excel"></i> Download Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/eda.js') }}"></script>
{% endblock %}